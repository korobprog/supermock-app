# –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ YooMoney –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–ø–ª–∞—Ç—ã

## üìã –ß–µ–∫-–ª–∏—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ YooMoney

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ YooMoney
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ—à–µ–ª–µ–∫ YooMoney (–µ—Å–ª–∏ –Ω–µ—Ç)
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ YooMoney
  - [ ] –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://yoomoney.ru/myservices/new
  - [ ] –£–∫–∞–∑–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - [ ] –£–∫–∞–∑–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
  - [ ] –ü–æ–ª—É—á–∏—Ç—å `client_id` –∏ `client_secret`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (scope):
  - [ ] `account-info` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—á–µ—Ç–µ
  - [ ] `operation-history` - –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
  - [ ] `operation-details` - –¥–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
  - [ ] `incoming-transfers` - –≤—Ö–æ–¥—è—â–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–æ—à–µ–ª—å–∫–∞ –≤–∫–ª—é—á–∏—Ç—å HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –£–∫–∞–∑–∞—Ç—å URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: `https://–≤–∞—à-–¥–æ–º–µ–Ω.com/api/payments/yoomoney/webhook`
- [ ] –ü–æ–ª—É—á–∏—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å")

### 3. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç PaymentForm
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
  - [ ] `receiver` - –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞
  - [ ] `quickpay-form` = "shop"
  - [ ] `targets` - –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
  - [ ] `sum` - —Å—É–º–º–∞
  - [ ] `paymentType` - —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (PC/AC)
  - [ ] `label` - —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
  - [ ] `successURL` - URL —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
  - [ ] `failURL` - URL –Ω–µ—É–¥–∞—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã

### 4. –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è webhook: `/api/payments/yoomoney/webhook`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `sha1_hash` –ø–∞—Ä–∞–º–µ—Ç—Ä
  - [ ] –í—ã—á–∏—Å–ª–∏—Ç—å —Ö—ç—à –ø–æ —Ñ–æ—Ä–º—É–ª–µ: `notification_type&operation_id&amount&currency&datetime&sender&codepro&notification_secret&label`
  - [ ] –°—Ä–∞–≤–Ω–∏—Ç—å —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º `sha1_hash`
- [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
  - [ ] `operation_id` - ID –æ–ø–µ—Ä–∞—Ü–∏–∏
  - [ ] `notification_type` - —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  - [ ] `amount` - —Å—É–º–º–∞
  - [ ] `currency` - –≤–∞–ª—é—Ç–∞ (643 –¥–ª—è —Ä—É–±–ª–µ–π)
  - [ ] `datetime` - –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
  - [ ] `sender` - –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
  - [ ] `label` - –º–µ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
  - [ ] `test_notification` - —Ñ–ª–∞–≥ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### 5. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –º–æ–¥–µ–ª–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Payment –≤ Prisma:
  ```prisma
  model Payment {
    id            String   @id @default(cuid())
    operationId   String   @unique
    amount        Decimal
    currency      String   @default("643")
    status        PaymentStatus @default(PENDING)
    label         String?  // –º–µ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
    sender        String?  // –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
    userId        String?  // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    productId     String?  // ID –ø—Ä–æ–¥—É–∫—Ç–∞
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
    user          User?    @relation(fields: [userId], references: [id])
    product       Product? @relation(fields: [productId], references: [id])
  }

  enum PaymentStatus {
    PENDING
    COMPLETED
    FAILED
    REFUNDED
  }
  ```
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –û–±–Ω–æ–≤–∏—Ç—å seed —Ñ–∞–π–ª

### 6. –õ–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
- [ ] –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ:
  - [ ] –ù–∞–π—Ç–∏ –ø–ª–∞—Ç–µ–∂ –ø–æ `operation_id`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
  - [ ] –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω:
    - [ ] –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ COMPLETED
    - [ ] –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–¥—É–∫—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    - [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    - [ ] –ó–∞–ø–∏—Å–∞—Ç—å –≤ –ª–æ–≥

### 7. API endpoints
- [ ] `POST /api/payments/yoomoney/webhook` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] `GET /api/payments/status/:operationId` - —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
- [ ] `POST /api/payments/create` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- [ ] `GET /api/payments/user/:userId` - –ø–ª–∞—Ç–µ–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 8. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏
- [ ] –•—Ä–∞–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å rate limiting –¥–ª—è webhook endpoint

### 9. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏ –∏ –≤–∞–ª—é—Ç–∞–º–∏

### 10. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–æ—Ä–º–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è YooMoney
```
notification_type=p2p-incoming
operation_id=904035776918098009
datetime=2014-04-28T16:31:28Z
sha1_hash=8693ddf402fe5dcc4c4744d466cabada2628148c
sender=41003188981230
codepro=false
currency=643
amount=0.99
withdraw_amount=1.00
label=YM.label.12345
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏
```javascript
const crypto = require('crypto');

function verifyYooMoneyNotification(params, secret) {
  const string = [
    params.notification_type,
    params.operation_id,
    params.amount,
    params.currency,
    params.datetime,
    params.sender,
    params.codepro,
    secret,
    params.label || ''
  ].join('&');
  
  const hash = crypto.createHash('sha1').update(string).digest('hex');
  return hash === params.sha1_hash;
}
```

### –ü—Ä–∏–º–µ—Ä –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã
```html
<form method="POST" action="https://yoomoney.ru/quickpay/confirm.xml">
  <input type="hidden" name="receiver" value="41003188981230">
  <input type="hidden" name="quickpay-form" value="shop">
  <input type="hidden" name="targets" value="–û–ø–ª–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ SuperMock">
  <input type="hidden" name="sum" value="100.00" data-type="number">
  <input type="hidden" name="paymentType" value="AC">
  <input type="hidden" name="label" value="payment_12345">
  <input type="hidden" name="successURL" value="https://supermock.com/payment/success">
  <input type="hidden" name="failURL" value="https://supermock.com/payment/fail">
  <button type="submit">–û–ø–ª–∞—Ç–∏—Ç—å 100 ‚ÇΩ</button>
</form>
```

## üåç –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å—Ç—Ä–∞–Ω—ã
- –†–æ—Å—Å–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä—ã–Ω–æ–∫)
- –ë–µ–ª–∞—Ä—É—Å—å
- –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
- –ê—Ä–º–µ–Ω–∏—è
- –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω
- –ú–æ–ª–¥–æ–≤–∞
- –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω

## üì± –ú–æ–±–∏–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- [ ] –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Ñ–æ—Ä–º—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å deep links –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ YooMoney –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- [ ] –í–æ–∑–≤—Ä–∞—Ç—ã (refunds)
- [ ] –ü–æ–¥–ø–∏—Å–∫–∏ –∏ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
- [ ] –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ —Å–∫–∏–¥–∫–∏
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM —Å–∏—Å—Ç–µ–º–æ–π
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
